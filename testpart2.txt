
def mark_attendance(request):
    if request.method == 'POST':
        # Get image from front-end (base64)
        img_data = request.POST.get('image')
        img_bytes = base64.b64decode(img_data.split(',')[1])
        nparr = np.frombuffer(img_bytes, np.uint8)
        img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)

        # Convert to RGB
        rgb_img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        unknown_encodings = face_recognition.face_encodings(rgb_img)

        if not unknown_encodings:
            return JsonResponse({'status': 'error', 'message': 'No face detected'})

        unknown_encoding = unknown_encodings[0]

        # Compare with all employees
        employees = Employee.objects.all()
        for emp in employees:
            if emp.face_encoding:
                emp_encoding = np.frombuffer(base64.b64decode(emp.face_encoding), dtype=np.float64)
                cos_sim = np.dot(emp_encoding, unknown_encoding) / (np.linalg.norm(emp_encoding) * np.linalg.norm(unknown_encoding))
                if cos_sim > 0.8:  # threshold
                    # Mark attendance
                    Attendance.objects.create(employee=emp)
                    return JsonResponse({'status': 'success', 'message': f'Attendance marked for {emp.name}'})

        return JsonResponse({'status': 'error', 'message': 'Face not recognized'})

    return render(request, 'core/attendance.html')
